<div class="event-search-bar">
  <!-- Row 1: Date Picker + Search Input + Clear Button -->
  <div class="search-row-1">
    <div class="left-section">
      <!-- Date Range Picker -->
      <div class="date-picker-wrapper">
        <app-date-range-picker
          #dateRangePicker
          [forceCompactMode]="true"
          [forceRightAlign]="false"
          (dateRangeSelected)="onDateRangeSelected($event)"
          (dateRangeCleared)="onDateRangeCleared()">
        </app-date-range-picker>
      </div>

      <!-- Search Field Dropdown (nếu có searchFieldOptions) -->
      <div class="filter-dropdown search-field-selector" *ngIf="showSearchInput && searchFieldOptions.length > 0" (clickOutside)="showSearchFieldDropdown = false">
        <button class="dropdown-trigger" (click)="toggleSearchFieldDropdown()">
          <span class="trigger-label">{{ getSearchFieldLabel() }}</span>
          <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </button>
        <div class="dropdown-menu" *ngIf="showSearchFieldDropdown">
          <div *ngFor="let option of searchFieldOptions" 
               class="dropdown-item"
               [class.selected]="selectedSearchField === option.value"
               (click)="selectSearchField(option)">
            <span class="item-label">{{ option.label }}</span>
            <svg *ngIf="selectedSearchField === option.value" class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Search Input -->
      <div class="search-input-wrapper" *ngIf="showSearchInput">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="text" 
          class="search-input" 
          [placeholder]="'Search... ' "
          [(ngModel)]="searchValue"
          (keypress)="onSearchKeyPress($event)">
      </div>

      <!-- Search Button -->
      <!-- <button class="search-btn" (click)="onSearch()" *ngIf="showSearchInput">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        Tìm kiếm
      </button> -->
    </div>

    <div class="right-section">
      <button class="clear-filter-btn" (click)="clearFilters()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
        Xóa bộ lọc
      </button>
    </div>
  </div>

  <!-- Row 2: Filter Dropdowns + Search Buttons -->
  <div class="search-row-2" *ngIf="showAdvancedSearch" [class.expanded]="showAdvancedFilters">
    <!-- Toggle button khi chưa mở rộng -->
    <div class="collapsed-view" *ngIf="!showAdvancedFilters">
      <button class="advanced-search-toggle-btn" (click)="toggleAdvancedFilters()">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
        Tìm kiếm nâng cao
      </button>
    </div>

    <!-- Full view khi mở rộng -->
    <div class="expanded-view" *ngIf="showAdvancedFilters">
      <div class="filters-section">
        <!-- Display Only Images (Object Image - Read Only) -->
        <div *ngIf="showImageUpload && displayOnlyImages.length > 0" class="filter-dropdown image-display-only">
          <div class="display-trigger">
            <svg class="image-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <span class="trigger-label">{{ imageLabel }}</span>
            
            <!-- Thumbnails hiển thị ảnh đối tượng (read-only) -->
            <div class="selected-images-preview">
              <div class="image-thumbnail" *ngFor="let imgUrl of displayOnlyImages.slice(0, 3)">
                <img [src]="imgUrl" [alt]="imageLabel" />
              </div>
              <div class="more-images" *ngIf="displayOnlyImages.length > 3">
                +{{ displayOnlyImages.length - 3 }}
              </div>
            </div>
          </div>
        </div>

        <!-- Image Upload Dropdown (Upload mode) -->
        <div *ngIf="showImageUpload && displayOnlyImages.length === 0" class="filter-dropdown image-upload-dropdown" (clickOutside)="showImageUploadDropdown = false">
          <button class="dropdown-trigger" (click)="toggleImageUploadDropdown()">
            <svg class="image-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <span class="trigger-label">{{ getImageUploadLabel() }}</span>
            
            <!-- Thumbnails hiển thị ảnh đã chọn -->
            <div class="selected-images-preview" *ngIf="uploadedImages.length > 0" (click)="$event.stopPropagation()">
              <div class="image-thumbnail" *ngFor="let img of uploadedImages.slice(0, 3)">
                <img [src]="img.thumbnailUrl || img.imageUrl" [alt]="img.fileName" />
              </div>
              <div class="more-images" *ngIf="uploadedImages.length > 3">
                +{{ uploadedImages.length - 3 }}
              </div>
            </div>
            
            <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </button>
          <div class="dropdown-menu image-upload-menu" *ngIf="showImageUploadDropdown" (click)="$event.stopPropagation()">
            <app-image-upload
              [autoUpload]="true"
              [allowMultiple]="true"
              [existingImages]="uploadedImages"
              (imagesUploaded)="handleImagesUploaded($event)">
            </app-image-upload>
          </div>
        </div>

        <!-- Threshold Slider (Hiển thị trực tiếp) -->
        <div *ngIf="showThresholdSlider" class="threshold-filter-inline">
          <label class="threshold-label">Ngưỡng tương đồng nhận diện</label>
          <div class="slider-container">
            <input 
              type="range" 
              min="0" 
              max="100" 
              step="1"
              class="threshold-slider"
              [style.background]="'linear-gradient(to right, #3b82f6 0%, #3b82f6 ' + thresholdPercentage + ', #e5e7eb ' + thresholdPercentage + ', #e5e7eb 100%)'"
              [(ngModel)]="threshold">
            <span class="threshold-value">{{ threshold }}%</span>
          </div>
        </div>

        <!-- Dynamic Filter Dropdowns -->
        <div *ngFor="let filter of filters" class="filter-dropdown" (clickOutside)="dropdownStates[filter.key] = false">
          <button class="dropdown-trigger" (click)="toggleDropdown(filter.key)">
            <span class="trigger-label">{{ getFilterLabel(filter.key) }}</span>
            <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </button>
          <div class="dropdown-menu" *ngIf="dropdownStates[filter.key]">
            <div *ngFor="let option of filter.options" 
                 class="dropdown-item"
                 [class.selected]="selectedFilters[filter.key] === option.value"
                 (click)="selectFilter(filter.key, option)">
              <span class="item-label" [title]="option.label">{{ option.label }}</span>
              <svg *ngIf="selectedFilters[filter.key] === option.value" class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="buttons-section">
        <!-- Search Button -->
        <button class="search-btn primary" (click)="onSearch()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          Tìm kiếm
        </button>

        <!-- Advanced Search Button -->
        <!-- <button *ngIf="showAdvancedSearch" class="search-btn secondary" (click)="onAdvancedSearch()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          Tìm kiếm nâng cao
        </button> -->
        
        <!-- Toggle button để đóng lại -->
        <button class="advanced-search-toggle-btn collapse" (click)="toggleAdvancedFilters()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6" transform="rotate(180 12 12)"/>
          </svg>
          Tìm kiếm nâng cao
        </button>
      </div>
    </div>
  </div>
</div>

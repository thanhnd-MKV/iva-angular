<div class="table-container">
  <!-- Empty State UI -->
  <div class="empty-state" *ngIf="(!dataSource.data || dataSource.data.length === 0) || hasError">
    <div class="empty-state-content">
      
      <!-- Error State -->
      <div *ngIf="hasError" class="error-state">
        <!-- Error Icon -->
        <div class="error-icon">
          <svg viewBox="0 0 64 64" width="56" height="56" fill="none" stroke="#f44336" stroke-width="2">
            <circle cx="32" cy="32" r="24"/>
            <path d="M32 20v12"/>
            <path d="M32 44h.01"/>
          </svg>
        </div>
        
        <!-- Error Content -->
        <div class="error-content">
          <h4 class="error-title">Không thể kết nối đến server</h4>
          <p class="error-description" *ngIf="!errorMessage">
            Không thể tải dữ liệu từ server. Vui lòng kiểm tra kết nối mạng và thử lại.
          </p>
          <p class="error-description" *ngIf="errorMessage">{{ errorMessage }}</p>
        </div>
      </div>

      <!-- No Data State -->
      <div *ngIf="!hasError" class="no-data-state">
        <!-- Simple Icon -->
        <div class="empty-icon">
          <svg viewBox="0 0 64 64" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="8" y="16" width="48" height="32" rx="4"/>
            <line x1="8" y1="28" x2="56" y2="28"/>
            <line x1="24" y1="16" x2="24" y2="48"/>
            <line x1="40" y1="16" x2="40" y2="48"/>
          </svg>
        </div>
        
        <!-- Simple Content -->
        <div class="empty-content">
          <h4 class="empty-title">Không có dữ liệu</h4>
          <p class="empty-description">Không tìm thấy kết quả phù hợp với điều kiện tìm kiếm.</p>
        </div>
      </div>
      
      <!-- Simple Actions -->
      <div class="empty-actions">
        <button class="refresh-btn" 
                [class.error-refresh-btn]="hasError"
                (click)="onRefresh()" 
                [disabled]="isRefreshing || isLoading">
          <svg *ngIf="!isRefreshing && !isLoading" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
          </svg>
          <svg *ngIf="isRefreshing || isLoading" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z" />
          </svg>
          {{ hasError ? 
              ((isRefreshing || isLoading) ? 'Đang kết nối...' : 'Thử lại') :
              ((isRefreshing || isLoading) ? 'Đang tải...' : 'Làm mới') 
          }}
        </button>
        
        <button class="clear-btn" (click)="onClearFilters()" *ngIf="hasActiveFilters && !hasError">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Xóa bộ lọc
        </button>
      </div>
    </div>
  </div>

  <!-- Table Content -->
  <div class="table-scroll-area" *ngIf="dataSource.data && dataSource.data.length > 0">
    <!-- Loading Overlay -->
    <div class="table-loading-overlay" 
         [class.show]="isTableLoading"
         [class.hide]="!isTableLoading">
      <div class="table-loading-spinner">
        <div class="spinner-icon"></div>
        <div class="spinner-text">Đang tải dữ liệu...</div>
      </div>
    </div>
    
    <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8 mat-table">

      <!-- Dynamic Columns -->
      <ng-container *ngFor="let column of columnsToDisplay" [matColumnDef]="column">
        <th mat-header-cell *matHeaderCellDef class="custom-header-cell" [style.width]="columnDefs[column].width || 'auto'">
          <!-- Checkbox header -->
          <mat-checkbox *ngIf="$any(columnDefs[column]?.type) === 'checkbox'" [checked]="isAllSelected()"
            [indeterminate]="hasSelection() && !isAllSelected()" (change)="toggleSelectAll($event)">
          </mat-checkbox>
          <!-- Regular header -->
          <span *ngIf="$any(columnDefs[column]?.type) !== 'checkbox'">
            {{ columnDefs[column].label || column }}
          </span>
        </th>

        <td mat-cell *matCellDef="let row; let i = index" class="custom-body-cell" [style.width]="columnDefs[column].width || 'auto'">

          <ng-container [ngSwitch]="true">

            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'checkbox'">
              <mat-checkbox [checked]="isSelected(row)" (change)="toggleSelection(row, $event)">
              </mat-checkbox>
            </ng-container>

            <!-- Image Column with Loading State -->
            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'image'">
              <div class="image-cell">
                <div class="image-container">
                  
                  <!-- Loading Skeleton -->
                  <div class="image-loading-skeleton" 
                       *ngIf="isImageLoading(row, column)">
                  </div>
                  
                  <!-- Error Placeholder -->
                  <div class="image-error-placeholder" 
                       *ngIf="isImageError(row, column)"
                       (click)="onImageClick(row)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="8.5" cy="8.5" r="1.5"/>
                      <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    <span>Lỗi ảnh</span>
                  </div>
                  
                  <!-- Actual Image -->
                  <img [src]="getDisplayValue(row, column)" 
                       [alt]="'Event image'" 
                       class="event-thumbnail"
                       [class.image-loading]="isImageLoading(row, column)"
                       [class.image-loaded]="!isImageLoading(row, column) && !isImageError(row, column)"
                       [class.image-error]="isImageError(row, column)"
                       [hidden]="isImageLoading(row, column) || isImageError(row, column)"
                       (load)="onImageLoad(row, column)"
                       (error)="onImageError(row, column, $event)"
                       (click)="onImageClick(row)">
                </div>
              </div>
            </ng-container>

            <!-- Status Column with Color Coding -->
            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'status'">
              <span class="status-badge" [ngClass]="getStatusClass(getDisplayValue(row, column))">
                {{ getStatusLabel(getDisplayValue(row, column)) }}
              </span>
            </ng-container>

            <!-- ID with Category Layout (2 lines) -->
            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'id-category'">
              <div class="id-category-cell clickable" (click)="onColumnClick(column, row); $event.stopPropagation()">
                <div class="id-number">{{ row.id || 'N/A' }}</div>
                <div class="category-label" [ngClass]="getCategoryClass(row.eventCategory)">
                  {{ getCategoryLabel(row.eventCategory) }}
                </div>
              </div>
            </ng-container>

            <!-- Attributes display (centered, bullet separated) -->
            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'attributes'">
              <div class="attributes-cell">
                {{ formatAttributes(row) }}
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'clickable'">
              <span class="clickable-text" [ngStyle]="{'color': columnDefs[column].textColor || '#007bff'}"
                (click)="onColumnClick(column, row)">
                {{ getDisplayValue(row, column) }}
              </span>
            </ng-container>

            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'link'">
              <a href="#" class="table-link" [ngStyle]="{'color': columnDefs[column].textColor || '#007bff'}">
                {{ getDisplayValue(row, column) }}
              </a>
            </ng-container>

            <ng-container *ngSwitchCase="$any(columnDefs[column]?.type) === 'date'">
              <div [innerHTML]="formatDate(getDisplayValue(row, column))"></div>
            </ng-container>

            <ng-container *ngSwitchCase="column === 'signalStrength'">
              <ng-container *ngIf="row.signalStrength !== null; else noSignal">
                <mat-icon [ngClass]="getSignalClass(row.signalStrength)">
                  {{ getSignalIcon(row.signalStrength) }}
                </mat-icon>
              </ng-container>
              <ng-template #noSignal>
                <span class="text-danger">No data</span>
              </ng-template>
            </ng-container>

            <ng-container *ngSwitchCase="column === 'battery'">
              <ng-container *ngIf="row.battery !== null; else noBattery">
                <mat-icon [matTooltip]="row.battery + '%'" [ngClass]="getBatteryClass(row.battery)">
                  {{ getBatteryIcon(row.battery) }}
                </mat-icon>
              </ng-container>
              <ng-template #noBattery>
                <span class="battery-danger">No data</span>
              </ng-template>
            </ng-container>

            <ng-container *ngSwitchDefault>
              {{ getDisplayValue(row, column) }}
            </ng-container>

          </ng-container>

        </td>
      </ng-container>

      <!-- Action Column with Chi tiết button -->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef class="action-header custom-header-cell">
          <!-- Empty header for alignment -->
        </th>
        <td mat-cell *matCellDef="let row" class="action-cell">
          <div class="detail-button" (click)="onActionClick('view', row)">
            Chi tiết
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
          (click)="onRowClick(row, $event)" 
          class="clickable-row"
          [class.highlighted-row]="isHighlighted(row)"></tr>
    </table>
  </div>
</div>
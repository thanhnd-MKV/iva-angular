<div class="notification-popup-overlay">
  <div class="notification-popup">
    <!-- Header -->
    <div class="popup-header">
      <div class="header-left">
        <mat-icon class="header-icon">notifications</mat-icon>
        <h2>Th√¥ng b√°o</h2>
        <span class="unread-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
      </div>
      <div class="header-actions">
        <button mat-button class="mark-all-btn" (click)="markAllAsRead()" *ngIf="unreadCount > 0">
          ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
        </button>
        <button mat-icon-button class="close-btn" (click)="close()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Notification List with Virtual Scrolling -->
    <div class="notification-list" (scroll)="onScroll($event)">
      <div *ngIf="notifications.length === 0" class="empty-state">
        <mat-icon class="empty-icon">notifications_none</mat-icon>
        <p class="empty-text">Kh√¥ng c√≥ th√¥ng b√°o n√†o</p>
      </div>

      <!-- Virtual scroll container -->
      <div *ngIf="notifications.length > 0" class="virtual-scroll-container" [style.height.px]="totalHeight">
        <!-- Spacer to offset items -->
        <div class="virtual-scroll-content" [style.transform]="'translateY(' + scrollOffset + 'px)'">
          <div 
            *ngFor="let notification of displayedNotifications; trackBy: trackByNotificationId" 
            class="notification-card"
            [class.unread]="!notification.read"
            [class]="'notification-' + notification.type"
            (click)="handleNotificationClick(notification)">
        
            <!-- Image on the left - with multiple fallback sources -->
            <div class="notification-image-container" 
                 *ngIf="notification.image || notification.data?.full?.croppedImagePath || notification.data?.full?.fullImagePath">
              <img [src]="notification.image || notification.data?.full?.croppedImagePath || notification.data?.full?.fullImagePath" 
                   alt="·∫¢nh s·ª± ki·ªán" 
                   (error)="onImageError($event)" />
            </div>

            <div class="notification-body">
              <div class="notification-header">
                <div class="notification-title-row">
                  <mat-icon class="notification-icon">{{ getIconName(notification.type) }}</mat-icon>
                  <h4 class="notification-title">{{ notification.title }}</h4>
                </div>
                <span class="notification-time">{{ notification.time }}</span>
              </div>

              <div class="notification-details">
                <!-- Suspect Name -->
                <div class="detail-row" *ngIf="notification.data?.full?.suspectName">
                  <span class="detail-label">üë§ ƒê·ªëi t∆∞·ª£ng:</span>
                  <span class="detail-value">{{ notification.data.full.suspectName }}</span>
                </div>

                <!-- Location -->
                <div class="detail-row" *ngIf="notification.location || notification.data?.full?.location">
                  <span class="detail-label">üìç V·ªã tr√≠:</span>
                  <span class="detail-value">{{ notification.location || notification.data.full.location }}</span>
                </div>

                <!-- Event Time -->
                <div class="detail-row" *ngIf="notification.eventTime || notification.data?.full?.eventTime">
                  <span class="detail-label">üïê Th·ªùi gian:</span>
                  <span class="detail-value">{{ formatEventTime(notification.eventTime || notification.data.full.eventTime) }}</span>
                </div>

                <!-- Event Type -->
                <div class="detail-row" *ngIf="notification.data?.full?.eventType">
                  <span class="detail-label">‚ö†Ô∏è Lo·∫°i:</span>
                  <span class="detail-value event-type">{{ getEventTypeName(notification.data.full.eventType) }}</span>
                </div>
              </div>
            </div>

            <button 
              mat-icon-button 
              class="delete-btn"
              (click)="deleteNotification(notification, $event)"
              matTooltip="X√≥a">
              <mat-icon>delete_outline</mat-icon>
            </button>

            <div class="unread-indicator" *ngIf="!notification.read"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

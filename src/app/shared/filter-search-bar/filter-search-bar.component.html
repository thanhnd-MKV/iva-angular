<!-- Input + Dropdown + Filter Tags in responsive layout -->
<!-- Gom t·∫•t c·∫£ navbar v√†o 1 container duy nh·∫•t -->
<div class="search-input-section">
  <div class="InputContainer" style="margin-right: 10px;">
    <!-- Shortcuts button -->
    <div class="compact-hints">
      <span class="shortcuts-icon" (click)="toggleShortcutsPopup()" title="Xem ph√≠m t·∫Øt"> <span
          class="hint-tooltip">üí°</span></span>

    </div>

    <div class="dropdown-wrapper" (clickOutside)="isOpen = false">
      <button class="menu-button" (click)="toggleMenu()">
        <div class="menu-op" style="display: flex;justify-content: space-between;width: 100%;">
          {{ selectedOption?.label || 'Ch·ªçn b·ªô l·ªçc  ' }}
          <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      <!-- Dropdown menu - moved inside dropdown-wrapper -->
      <div class="menu-items" *ngIf="isOpen">
        <button class="menu-item" *ngFor="let item of items; let i = index"
          (click)="selectMode({label: item.label, value: item.value, icon: item.icon || 'default_icon'})"
          [class.status-item]="item.label === 'Tr·∫°ng th√°i'">
          <app-icon class="icon-menu" [name]="item.icon"></app-icon>
          {{item.label}}
          <kbd class="shortcut">{{item.key}}</kbd>
        </button>
      </div>
    </div>

    <!-- Input ho·∫∑c Status Select -->
    <input *ngIf="selectedOption?.label !== 'Tr·∫°ng th√°i' && selectedOption?.label !== 'S·ª± ki·ªán' && selectedOption?.label !== 'H√¨nh ·∫£nh'" type="text" name="text" class="input" id="input"
      [placeholder]="isListening ? (isIdField() ? 'üé§ N√≥i s·ªë ID...' : 'üé§ ƒêang l·∫Øng nghe...') : 'Nh·∫≠p t√¨m ki·∫øm'"
      [(ngModel)]="inputValue" (keydown.enter)="onEnterKey()" [disabled]="!selectedLabel || isListening"
      [class.push-to-talk-mode]="isListening" #searchInput />

    <!-- Status Select Dropdown -->
    <div *ngIf="selectedOption?.label === 'Tr·∫°ng th√°i'" class="status-select"
      (clickOutside)="isStatusSelectOpen = false">
      <button class="status-select-trigger" (click)="toggleStatusSelect()" [class.open]="isStatusSelectOpen"
        [class]="'status-select-trigger ' + getStatusTriggerClass()">
        <span class="select-text">{{ getStatusSelectText() }}</span>
        <svg class="chevron-icon" [class.open]="isStatusSelectOpen" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24">
          <path d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <div class="status-select-options" *ngIf="isStatusSelectOpen">
        <button class="status-option processed" (click)="selectStatusOption('processed')">
          ƒê√£ x·ª≠ l√Ω
        </button>
        <button class="status-option pending" (click)="selectStatusOption('pending')">
          Ch∆∞a x·ª≠ l√Ω
        </button>
      </div>
    </div>

    <!-- Event Type Select Dropdown (2-level hierarchy) -->
    <div *ngIf="selectedOption?.label === 'S·ª± ki·ªán'" class="event-select"
      (clickOutside)="isEventSelectOpen = false">
      <button class="event-select-trigger" 
        (click)="toggleEventSelect()" 
        [class.open]="isEventSelectOpen"
        [class.selected]="selectedEventType">
        <span class="select-text">{{ getEventSelectText() }}</span>
        <svg class="chevron-icon" [class.open]="isEventSelectOpen" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24">
          <path d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <div class="event-select-options" *ngIf="isEventSelectOpen">
        <div class="event-category" *ngFor="let category of eventTypeHierarchy">
          <div class="category-header">{{ category.category }}</div>
          <div class="category-items">
            <div class="event-item" *ngFor="let item of category.items">
              <!-- Main item button -->
              <button 
                class="event-option" 
                [class.has-subitems]="item.subItems && item.subItems.length > 0"
                [class.selected]="selectedEventType === item.value"
                (click)="selectEventItem(item, category.category)"
                [disabled]="item.subItems && item.subItems.length > 0">
                {{ item.label }}
              </button>
              
              <!-- Sub-items if exist -->
              <div class="event-subitems" *ngIf="item.subItems && item.subItems.length > 0">
                <button 
                  class="event-subitem" 
                  [class.selected]="selectedEventType === subItem.value"
                  *ngFor="let subItem of item.subItems"
                  (click)="selectEventSubItem(subItem, item, category.category)">
                  + {{ subItem.label }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Upload Button -->
    <button 
      *ngIf="selectedOption?.label === 'H√¨nh ·∫£nh'" 
      class="image-upload-button"
      (click)="toggleImageUpload()"
      type="button"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="upload-icon">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      <span>{{ uploadedImages.length > 0 ? 'Qu·∫£n l√Ω ·∫£nh (' + uploadedImages.length + ')' : 'T·∫£i ·∫£nh l√™n' }}</span>
    </button>

    <div class="border"></div>

    <!-- Search icon -->
    <label (click)="onEnterKey()" for="input" class="labelforsearch">
      <svg viewBox="0 0 512 512" class="searchIcon">
        <path
          d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z">
        </path>
      </svg>
    </label>

    <div class="border"></div>

    <!-- Mic -->
    <button class="micButton" (click)="toggleSpeechRecognition()" [class.listening]="isListening"
      [disabled]="!speechSupported" [title]="isListening ? 'D·ª´ng nh·∫≠n di·ªán gi·ªçng n·ªëi' : 'B·∫Øt ƒë·∫ßu nh·∫≠n di·ªán gi·ªçng n√≥i'">
      <svg viewBox="0 0 384 512" class="micIcon" [class.active]="isListening">
        <path
          d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z">
        </path>
      </svg>
    </button>

  </div>

  <app-date-range-picker #dateRangePicker 
    (dateRangeSelected)="onDateRangeSelected($event)"
    (dateRangeCleared)="onDateRangeCleared()"></app-date-range-picker>

  <!-- Filter tags - t·ª´ng ph·∫ßn t·ª≠ ri√™ng l·∫ª v·ªõi h·ªá th·ªëng m√†u m·ªõi -->
  <div class="filter-tag" [class.tag-id]="isIdTag(tag)" [class.tag-location]="isLocationTag(tag)"
    [class.tag-device]="isDeviceTag(tag)" [class.tag-status]="isStatusTag(tag)" [class.tag-event]="isEventTag(tag)" 
    [class.tag-date]="isDateTag(tag)" [class.tag-image]="isImageTag(tag)"
    [class.status-processed]="isStatusTag(tag) && tag.value === 'ƒê√£ x·ª≠ l√Ω'"
    [class.status-pending]="isStatusTag(tag) && tag.value === 'Ch∆∞a x·ª≠ l√Ω'"
    *ngFor="let tag of selectedTags; let i = index"
    (click)="isImageTag(tag) && onImageTagClick()">
    <app-icon *ngIf="tag.icon" class="icon-menu" [name]="tag.icon"></app-icon>
    <span class="tag-label">{{ getTagLabel(tag.key) }}</span>
    <span class="tag-value">{{ tag.value }}</span>
    <button class="remove-btn" (click)="removeTag(i); $event.stopPropagation()" [title]="'X√≥a b·ªô l·ªçc: ' + tag.key">√ó</button>
  </div>
</div> <!-- Voice input indicator -->
<div class="push-to-talk-indicator" *ngIf="isListening">
  <svg class="mic-icon" viewBox="0 0 384 512">
    <path fill="currentColor"
      d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z">
    </path>
  </svg>
  <div class="indicator-text">
    <div>{{ isIdField() ? 'ƒêang l·∫Øng nghe s·ªë ID...' : 'ƒêang l·∫Øng nghe...' }}</div>
    <div class="auto-search-hint">S·∫Ω t·ª± ƒë·ªông t√¨m ki·∫øm sau 2.5s im l·∫∑ng</div>
  </div>
  <span class="key-indicator">Shift+V ƒë·ªÉ t·∫Øt</span>
</div>

<!-- Shortcuts Popup -->
<div class="shortcuts-popup-overlay" *ngIf="showShortcutsPopup" (click)="closeShortcutsPopup()">
  <div class="shortcuts-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h3>‚å®Ô∏è Ph√≠m t·∫Øt h·ªá th·ªëng</h3>
      <button class="close-btn" (click)="closeShortcutsPopup()">√ó</button>
    </div>

    <div class="shortcuts-content">
      <div class="shortcut-section">
        <h4>üé§ Gi·ªçng n√≥i</h4>
        <div class="shortcut-item">
          <kbd>Shift</kbd> + <kbd>V</kbd>
          <span>B·∫≠t/t·∫Øt nh·∫≠n di·ªán gi·ªçng n√≥i</span>
        </div>
      </div>

      <div class="shortcut-section">
        <h4>üîç T√¨m ki·∫øm nhanh</h4>
        <div class="shortcut-item">
          <kbd>I</kbd>
          <span>Ch·ªçn t√¨m ki·∫øm theo ID</span>
        </div>
        <div class="shortcut-item">
          <kbd>L</kbd>
          <span>Ch·ªçn t√¨m ki·∫øm theo v·ªã tr√≠</span>
        </div>
        <div class="shortcut-item">
          <kbd>D</kbd>
          <span>Ch·ªçn t√¨m ki·∫øm theo thi·∫øt b·ªã</span>
        </div>
        <div class="shortcut-item">
          <kbd>S</kbd>
          <span>Ch·ªçn t√¨m ki·∫øm theo tr·∫°ng th√°i</span>
        </div>
        <div class="shortcut-item">
          <kbd>H</kbd>
          <span>Ch·ªçn t√¨m ki·∫øm theo h√¨nh ·∫£nh</span>
        </div>
        <div class="shortcut-item">
          <kbd>Enter</kbd>
          <span>Th·ª±c hi·ªán t√¨m ki·∫øm</span>
        </div>
      </div>

      <div class="shortcut-section">
        <h4>‚úÖ Tr·∫°ng th√°i (khi ch·ªçn Tr·∫°ng th√°i)</h4>
        <div class="shortcut-item">
          <kbd>1</kbd>
          <span>Ch·ªçn "ƒê√£ x·ª≠ l√Ω" v√† t√¨m ki·∫øm</span>
        </div>
        <div class="shortcut-item">
          <kbd>2</kbd>
          <span>Ch·ªçn "Ch∆∞a x·ª≠ l√Ω" v√† t√¨m ki·∫øm</span>
        </div>
      </div>

      <div class="shortcut-section">
        <h4>üéØ Kh√°c</h4>
        <div class="shortcut-item">
          <kbd>Esc</kbd>
          <span>ƒê√≥ng popup/dropdown</span>
        </div>
        <div class="shortcut-item">
          <kbd>F3</kbd>
          <span>Focus v√†o √¥ t√¨m ki·∫øm</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Image Upload Modal -->
<div class="image-upload-modal-overlay" *ngIf="isImageUploadOpen" (click)="onImageUploadCancelled()">
  <div class="image-upload-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ uploadedImages.length > 0 ? 'Qu·∫£n l√Ω ·∫£nh t√¨m ki·∫øm' : 'T·∫£i ·∫£nh l√™n ƒë·ªÉ t√¨m ki·∫øm' }}</h3>
      <button class="close-button" (click)="onImageUploadCancelled()" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <app-image-upload 
        [existingImages]="uploadedImages"
        [allowMultiple]="true"
        (imagesUploaded)="onImagesUploaded($event)"
        (uploadCancelled)="onImageUploadCancelled()">
      </app-image-upload>
    </div>
  </div>
</div>
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { MatIconModule } from '@angular/material/icon';
import { MatButtonModule } from '@angular/material/button';
import { MatSnackBar, MatSnackBarModule } from '@angular/material/snack-bar';
import { CameraService } from './camera.service';

@Component({
  selector: 'app-camera-list',
  standalone: true,
  templateUrl: './camera-list.component.html',
  styleUrls: ['./camera-list.component.css'],
  imports: [
    CommonModule,
    MatIconModule,
    MatButtonModule,
    MatSnackBarModule
  ],
})
export class CameraListComponent implements OnInit {
  cameras: any[] = [];
  totalCameras = 0;
  loading = false;

  constructor(
    private cameraService: CameraService,
    private snackBar: MatSnackBar
  ) {}

  ngOnInit(): void {
    this.loadCameras();
  }

  loadCameras(): void {
    this.loading = true;
    this.cameraService.getAllCameras().subscribe({
      next: (response) => {
        if (response && response.data) {
          this.cameras = response.data;
          this.totalCameras = this.cameras.length;
        } else {
          this.cameras = [];
          this.totalCameras = 0;
        }
        this.loading = false;
      },
      error: (error) => {
        console.error('Error loading cameras:', error);
        this.snackBar.open('Lỗi tải danh sách camera', 'Đóng', { duration: 3000 });
        this.loading = false;
      }
    });
  }

  getCategoryIcon(category: string): string {
    return category === 'PERSON' ? 'person' : 'directions_car';
  }

  getCategoryLabel(category: string): string {
    return category === 'PERSON' ? 'Đối tượng người' : 'Giao thông';
  }

  toggleCameraStatus(camera: any): void {
    const newStatus = camera.connectionStatus === 1 ? 0 : 1;
    
    this.cameraService.updateCameraStatus(camera.id, newStatus).subscribe({
      next: (response) => {
        camera.connectionStatus = newStatus;
        const statusText = newStatus === 1 ? 'bật' : 'tắt';
        this.snackBar.open(`Đã ${statusText} camera ${camera.name}`, 'Đóng', { duration: 2000 });
      },
      error: (error) => {
        console.error('Error updating camera status:', error);
        this.snackBar.open('Lỗi cập nhật trạng thái camera', 'Đóng', { duration: 3000 });
      }
    });
  }

  openCameraSettings(camera: any): void {
    console.log('Open settings for camera:', camera);
    this.snackBar.open('Tính năng đang phát triển', 'Đóng', { duration: 2000 });
  }
}
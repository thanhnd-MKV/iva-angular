<div class="filter-bar">
  <div class="filter-left">
    <!-- <div class="search-box">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" placeholder="Tìm kiếm" class="search-input" [(ngModel)]="searchText" (keyup.enter)="onSearch()">
    </div> -->

    <app-date-range-picker (dateRangeSelected)="onDateRangeSelected($event)"
      (dateRangeCleared)="onDateRangeCleared()">
    </app-date-range-picker>

        <div class="filter-btn-wrapper">
      <button class="filter-btn camera-btn" [class.active]="showCameraDropdown || selectedCamera !== ''"
        (click)="toggleCameraDropdown()">
        <mat-icon class="btn-icon">videocam</mat-icon>
        <span>{{ getCameraLabel() }}</span>
        <mat-icon class="dropdown-icon">expand_more</mat-icon>
      </button>

      <div class="dropdown-menu camera-dropdown" *ngIf="showCameraDropdown">
        <div class="dropdown-item" *ngFor="let option of cameraOptions"
          [class.selected]="selectedCamera === option.value" (click)="selectCamera(option.value)">
          {{ option.label }}
        </div>
      </div>
    </div>

    <div class="filter-btn-wrapper">
      <button class="filter-btn area-btn" [class.active]="showAreaDropdown || selectedArea !== ''"
        (click)="toggleAreaDropdown()">
        <mat-icon class="btn-icon">location_on</mat-icon>
        <span>{{ getAreaLabel() }}</span>
        <mat-icon class="dropdown-icon">expand_more</mat-icon>
      </button>

      <div class="dropdown-menu area-dropdown" *ngIf="showAreaDropdown">
        <div class="dropdown-item" *ngFor="let option of areaOptions" [class.selected]="selectedArea === option.value"
          (click)="selectArea(option.value)">
          {{ option.label }}
        </div>
      </div>
    </div>

    <button class="filter-btn clear-btn" (click)="clearFilters()"
      *ngIf="hasActiveFilters || selectedTimeRange === 'custom'">
      <mat-icon class="btn-icon">close</mat-icon>
      <span>Xóa bộ lọc</span>
    </button>
  </div>

  <div class="filter-right">
    <button class="export-btn" (click)="exportReport()">
      <mat-icon class="btn-icon">download</mat-icon>
      <span>Xuất báo cáo</span>
    </button>
  </div>
</div>

<div class="statistics-container">


  <!-- Top Section: Donut Chart + Bar Chart -->
  <div class="top-section">

    <div class="left-section">
      <!-- Summary Cards Section -->
      <div class="summary-cards-section">
        <div class="summary-card" [ngClass]="'summary-card-' + card.color"
          *ngFor="let card of summaryCards; let i = index; trackBy: trackByCardIndex">
          <div class="summary-header">
            <span class="summary-title">{{ card.title }}</span>
          </div>
          <div class="summary-body">
            <span class="summary-value" *ngIf="typeof card.value === 'number'">
              <span #digitSpan *ngFor="let digitObj of getCardDigits(i); trackBy: trackByDigit; let digitIndex = index"
                class="digit" [class.digit-animate]="digitObj.animate" [attr.data-trigger]="animationTrigger"
                [attr.data-animate]="digitObj.animate">{{ digitObj.digit }}</span>
            </span>
            <span class="summary-value" *ngIf="typeof card.value === 'string'">{{ card.value }}</span>
            <span class="summary-change" [class.positive]="card.isPositive" [class.negative]="!card.isPositive">
              <mat-icon class="change-icon">{{ card.isPositive ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
              {{ card.change }}%
            </span>
          </div>
        </div>
      </div>
      <!-- Donut Chart -->
      <div class="chart-card donut-chart-card">
        <h3 class="chart-title">Thống kê lượt xuất hiện độ tuổi</h3>
        <div class="donut-wrapper" [class.loading]="isDonutChartLoading">
          <div *ngIf="isDonutChartLoading" class="loading-overlay">
            <mat-spinner diameter="40"></mat-spinner>
          </div>
          <div class="donut-content">
            <div class="donut-chart">
              <canvas #donutChart baseChart [data]="donutChartData" [options]="donutChartOptions" type="doughnut">
              </canvas>
              <div class="donut-center">
                <div class="total-label">Tổng</div>
                <div class="total-value">{{ totalPeopleCount }}</div>
              </div>
            </div>
            <div class="donut-legend">
              <div class="legend-item" *ngFor="let item of donutChartData.labels; let i = index"
                [class.hidden]="isAgeGroupHidden(item)" (click)="toggleAgeGroup(item)">
                <div style="display: flex;justify-content: space-between;width: 280px;">
                  <div style="display: flex;">
                    <div style="margin-right: 10px;" class="legend-color"
                      [style.background-color]="getBackgroundColor(i)"></div>
                    <span class="legend-label">{{ item }}</span>
                  </div>
                  <div style="width: 100px;">
                    <span class="legend-value"  >{{ getAgeGroupCount(item) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bar Chart -->
    <div class="chart-card bar-chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Thống kê nhân chủng học</h3>
        <div class="chart-legend-inline">
          <div class="legend-item-inline" *ngFor="let dataset of barChartData.datasets; let i = index"
            [class.legend-hidden]="isDatasetHidden(i)" (click)="toggleDataset(i)">
            <span class="legend-dot" [style.background-color]="dataset.backgroundColor"></span>
            <span class="legend-text">{{ dataset.label }}</span>
          </div>
        </div>
      </div>
      <div class="chart-wrapper" [class.loading]="isBarChartLoading" [style.height]="barChartHeight">
        <div *ngIf="isBarChartLoading" class="loading-overlay">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        <canvas #barChart baseChart [data]="barChartData" [options]="barChartOptions" type="bar">
        </canvas>
      </div>
    </div>

    <!-- Donut Chart with Legend -->

  </div>

  <!-- Bottom Section: Line Chart -->
  <div class="bottom-section">
    <div class="chart-card line-chart-card">
      <h3 class="chart-title">Lượt xuất hiện của các đối tượng</h3>
      <div class="chart-wrapper" [class.loading]="isLineChartLoading" [style.height]="lineChartHeight">
        <div *ngIf="isLineChartLoading" class="loading-overlay">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        <canvas #lineChart baseChart [data]="lineChartData" [options]="lineChartOptions" type="line">
        </canvas>
      </div>
    </div>
  </div>
</div>
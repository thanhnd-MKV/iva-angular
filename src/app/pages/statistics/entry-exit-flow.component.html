<div class="filter-bar">
  <div class="filter-left">
    <!-- <div class="search-box">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" placeholder="Tìm kiếm" class="search-input" [(ngModel)]="searchText" (keyup.enter)="onSearch()">
    </div> -->

    <div class="filter-btn-wrapper">
      <button class="filter-btn time-btn" [class.active]="showTimeDropdown" (click)="toggleTimeDropdown()">
        <mat-icon class="btn-icon">calendar_today</mat-icon>
        <span>{{ getTimeRangeLabel() }}</span>
        <mat-icon class="dropdown-icon">expand_more</mat-icon>
      </button>
      
      <div class="dropdown-menu time-dropdown" *ngIf="showTimeDropdown">
        <div class="dropdown-item" *ngFor="let option of timeOptions" 
             [class.selected]="selectedTimeRange === option.value"
             (click)="selectTimeRange(option.value)">
          {{ option.label }}
        </div>
      </div>
    </div>
    
    <app-date-range-picker 
      *ngIf="selectedTimeRange === 'custom'"
      (dateRangeSelected)="onDateRangeSelected($event)"
      (dateRangeCleared)="onDateRangeCleared()">
    </app-date-range-picker>

    <div class="filter-btn-wrapper">
      <button class="filter-btn camera-btn" [class.active]="showCameraDropdown || selectedCamera !== ''" (click)="toggleCameraDropdown()">
        <mat-icon class="btn-icon">videocam</mat-icon>
        <span>{{ getCameraLabel() }}</span>
        <mat-icon class="dropdown-icon">expand_more</mat-icon>
      </button>
      
      <div class="dropdown-menu camera-dropdown" *ngIf="showCameraDropdown">
        <div class="dropdown-item" *ngFor="let option of cameraOptions"
             [class.selected]="selectedCamera === option.value"
             (click)="selectCamera(option.value)">
          {{ option.label }}
        </div>
      </div>
    </div>

    <div class="filter-btn-wrapper">
      <button class="filter-btn area-btn" [class.active]="showAreaDropdown || selectedArea !== ''" (click)="toggleAreaDropdown()">
        <mat-icon class="btn-icon">location_on</mat-icon>
        <span>{{ getAreaLabel() }}</span>
        <mat-icon class="dropdown-icon">expand_more</mat-icon>
      </button>
      
      <div class="dropdown-menu area-dropdown" *ngIf="showAreaDropdown">
        <div class="dropdown-item" *ngFor="let option of areaOptions"
             [class.selected]="selectedArea === option.value"
             (click)="selectArea(option.value)">
          {{ option.label }}
        </div>
      </div>
    </div>

    <button class="filter-btn clear-btn" (click)="clearFilters()" *ngIf="hasActiveFilters || selectedTimeRange === 'custom'">
      <mat-icon class="btn-icon">close</mat-icon>
      <span>Xóa bộ lọc</span>
    </button>
  </div>
  
  <div class="filter-right">
    <button class="export-btn" (click)="exportReport()">
      <mat-icon class="btn-icon">download</mat-icon>
      <span>Xuất báo cáo</span>
    </button>
  </div>
</div>

<div class="statistics-container" [class.sidebar-opened]="isSidebarOpened" [class.sidebar-closed]="!isSidebarOpened">
  <!-- Summary Cards Row -->
  

  <div class="main-content">
    <!-- Map Section -->
 <div>
      <div class="summary-cards-section">
    <div class="summary-card" [ngClass]="'summary-card-' + card.color" *ngFor="let card of summaryCards; let i = index; trackBy: trackByCardIndex">
      <div class="summary-header">
        <span class="summary-title">{{ card.title }}</span>
      </div>
      <div class="summary-body">
        <span class="summary-value" *ngIf="typeof card.value === 'number'">
          <span 
            #digitSpan
            *ngFor="let digitObj of getCardDigits(i); trackBy: trackByDigit; let digitIndex = index"
            class="digit"
            [class.digit-animate]="digitObj.animate"
            [attr.data-trigger]="animationTrigger"
            [attr.data-animate]="digitObj.animate"
          >{{ digitObj.digit }}</span>
        </span>
        <span class="summary-value" *ngIf="typeof card.value === 'string'">{{ card.value }}</span>
        <span class="summary-change" [class.positive]="card.isPositive" [class.negative]="!card.isPositive">
          <mat-icon class="change-icon">{{ card.isPositive ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
          {{ card.change }}%
        </span>
      </div>
    </div>
  </div>
    <div class="map-section">
      <div class="map-card luu-luong-map">
        <h3 class="chart-title">Thống kê lưu lượng theo Camera</h3>
        <div class="map-wrapper">
          <!-- Force recreate map when cameraLocations changes -->
          <app-traffic-flow-map 
            *ngIf="cameraLocations && cameraLocations.length > 0"
            [attr.data-key]="mapKey"
            [cameraLocations]="cameraLocations"
            [mapCenter]="mapCenter"
            [mapZoom]="mapZoom">
          </app-traffic-flow-map>
          <div *ngIf="!cameraLocations || cameraLocations.length === 0" class="no-data-message">
            <mat-icon>location_off</mat-icon>
            <p>Không có dữ liệu camera</p>
          </div>
        </div>
      </div>
    </div>
 </div>

    <!-- Charts Section -->
    <div class="charts-section">
     <!-- Line Chart Section -->
  <div class="chart-section">
    <div class="chart-card line-chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Lượt đến/ rời đi theo giờ trong ngày</h3>
        <div class="chart-controls">
          <div class="chart-filter-buttons">
            <button class="chart-filter-btn" 
                    [class.active]="lineChartFilter === 'all'"
                    (click)="setLineChartFilter('all')">
              Tất cả
            </button>
            <button class="chart-filter-btn" 
                    [class.active]="lineChartFilter === 'in'"
                    (click)="setLineChartFilter('in')">
              <span class="filter-dot" style="background-color: #10b981;"></span>
              Lượt đến
            </button>
            <button class="chart-filter-btn" 
                    [class.active]="lineChartFilter === 'out'"
                    (click)="setLineChartFilter('out')">
              <span class="filter-dot" style="background-color: #8b5cf6;"></span>
              Lượt rời đi
            </button>
          </div>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-wrapper" [class.loading]="isLineChartLoading">
          <div *ngIf="isLineChartLoading" class="loading-overlay">
            <mat-spinner diameter="40"></mat-spinner>
          </div>
          <canvas #lineChart
            baseChart 
            [data]="lineChartData" 
            [options]="lineChartOptions" 
            type="line">
          </canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Bar Chart Section -->
  <div class="chart-section">
    <div class="chart-card bar-chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Lưu lượng ra vào theo từng khu vực</h3>
        <div class="chart-controls">
          <div class="chart-filter-buttons">
            <button class="chart-filter-btn" 
                    [class.active]="barChartFilter === 'all'"
                    (click)="setBarChartFilter('all')">
              Tất cả
            </button>
            <button class="chart-filter-btn" 
                    [class.active]="barChartFilter === 'in'"
                    (click)="setBarChartFilter('in')">
              <span class="filter-dot" style="background-color: #10b981;"></span>
              Lượt đến
            </button>
            <button class="chart-filter-btn" 
                    [class.active]="barChartFilter === 'out'"
                    (click)="setBarChartFilter('out')">
              <span class="filter-dot" style="background-color: #8b5cf6;"></span>
              Lượt rời đi
            </button>
          </div>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-wrapper" [class.loading]="isBarChartLoading">
          <div *ngIf="isBarChartLoading" class="loading-overlay">
            <mat-spinner diameter="40"></mat-spinner>
          </div>
          <canvas #barChart
            baseChart 
            [data]="barChartData" 
            [options]="barChartOptions" 
            type="bar">
          </canvas>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>

<div class="object-form-container">
  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Form -->
  <div *ngIf="!isLoading" class="form-content">
    <div class="form-card">
      <form [formGroup]="objectForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <!-- Left Column -->
          <div class="form-column">
            <!-- Image Upload -->
            <div class="image-upload-section">
              <label>Hình ảnh</label>
              <div class="upload-area">
                <div class="uploaded-images" *ngIf="uploadedImages.length > 0; else noImage">
                  <div *ngFor="let img of uploadedImages; let i = index" class="image-preview">
                    <img [src]="img" alt="Preview">
                    <button *ngIf="!isViewMode" type="button" mat-icon-button class="remove-btn" (click)="removeImage(i)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
                <ng-template #noImage>
                  <div class="image-preview">
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 10px;">
                      <mat-icon style="font-size: 50px; width: 50px; height: 50px; opacity: 0.3; color: #999;">image</mat-icon>
                      <span class="upload-hint" style="margin-top: 8px;">KHÔNG CÓ ẢNH</span>
                    </div>
                  </div>
                </ng-template>
                <button *ngIf="!isViewMode" type="button" class="upload-btn" (click)="triggerImageUpload()">
                  <mat-icon>cloud_upload</mat-icon>
                  <span>Tải hình ảnh</span>
                </button>
                <input type="file" id="imageUpload" hidden multiple accept="image/*" (change)="onImageUpload($event)" [disabled]="isViewMode">
              </div>
            </div>

            <!-- Basic Info -->
            <div class="form-group">
              <label>Họ và tên</label>
              <input type="text" formControlName="name" placeholder="">
            </div>

            <div class="form-group">
              <label>ID đối tượng</label>
              <input type="text" 
                     formControlName="objectId" 
                     placeholder="" 
                     [readonly]="isEditMode || isViewMode"
                     [class.input-disabled]="isEditMode || isViewMode">
            </div>

            <div class="form-group">
              <label>Nhóm đối tượng</label>
              <select formControlName="groupType" [class.select-blacklist]="objectForm.get('groupType')?.value === 'blacklist'">
                <option *ngFor="let type of groupTypes" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Nguồn dữ liệu</label>
              <input type="text" formControlName="dataSource" readonly class="input-disabled">
            </div>
          </div>

          <!-- Right Column -->
          <div class="form-column">
            <h4>Thông tin cá nhân</h4>

            <div class="form-group">
              <label>Số CCCD</label>
              <input type="text" 
                     formControlName="cccdNumber" 
                     placeholder="Nhập 12 số"
                     maxlength="12"
                     [class.input-error]="objectForm.get('cccdNumber')?.invalid && objectForm.get('cccdNumber')?.touched">
              <div class="error-message" *ngIf="objectForm.get('cccdNumber')?.invalid && objectForm.get('cccdNumber')?.touched">
                <span *ngIf="objectForm.get('cccdNumber')?.errors?.['invalidCccdFormat']">
                  <mat-icon>error</mat-icon>
                  Số CCCD phải là 12 chữ số, không chứa chữ cái hoặc ký tự đặc biệt
                </span>
                <span *ngIf="objectForm.get('cccdNumber')?.errors?.['duplicate']">
                  <mat-icon>error</mat-icon>
                  Số CCCD này đã tồn tại trong hệ thống
                </span>
              </div>
            </div>

            <div class="form-group">
              <label>Quốc tích</label>
              <div class="searchable-select-wrapper">
                <div class="select-display" 
                     [class.disabled]="isViewMode"
                     (click)="!isViewMode && (nationalityDropdownOpen = !nationalityDropdownOpen)">
                  <span class="select-value" *ngIf="objectForm.get('nationality')?.value">
                    {{ objectForm.get('nationality')?.value }}
                  </span>
                  <span class="select-placeholder" *ngIf="!objectForm.get('nationality')?.value">
                    Chọn quốc tích
                  </span>
                  <mat-icon class="dropdown-icon" [class.open]="nationalityDropdownOpen">arrow_drop_down</mat-icon>
                </div>
                <div class="select-dropdown" *ngIf="nationalityDropdownOpen && !isViewMode">
                  <div class="search-input-wrapper">
                    <input 
                      type="text" 
                      class="search-input"
                      [formControl]="nationalitySearchControl"
                      placeholder="Tìm kiếm quốc tịch..."
                      (click)="$event.stopPropagation()"
                    />
                    <mat-icon class="search-icon">search</mat-icon>
                  </div>
                  <div class="options-list">
                    <div 
                      class="option-item" 
                      *ngFor="let nation of filteredNationalities"
                      [class.selected]="objectForm.get('nationality')?.value === nation.value"
                      (click)="selectNationality(nation.value); $event.stopPropagation()"
                    >
                      {{ nation.label }}
                    </div>
                    <div class="no-results" *ngIf="filteredNationalities.length === 0">
                      Không tìm thấy kết quả
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Ngày cấp CCCD</label>
              <app-date-picker class="date-form-group" style="max-height: 720px;" formControlName="cccdIssueDate" placeholder=""></app-date-picker>
            </div>

            <div class="form-group">
              <label>Nơi cấp CCCD</label>
              <input type="text" formControlName="cccdIssuePlace" placeholder="">
            </div>

            <div class="form-group">
              <label>Ngày Sinh</label>
              <app-date-picker class="date-form-group" style="max-height: 720px;" formControlName="dateOfBirth" placeholder="Chọn ngày sinh"></app-date-picker>
            </div>

            <div class="form-group">
              <label>Giới tính</label>
              <select formControlName="gender">
                <option value="">Chọn giới tính</option>
                <option value="Nam">Nam</option>
                <option value="Nữ">Nữ</option>
                <option value="Khác">Khác</option>
              </select>
            </div>

            <div class="form-group">
              <label>Quê quán</label>
              <input type="text" formControlName="origin" placeholder="">
            </div>

            <div class="form-group">
              <label>Nơi thường trú</label>
              <input type="text" formControlName="residence" placeholder="">
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <!-- View Mode Actions (Detail page) -->
          <ng-container *ngIf="isViewMode">
            <button class="btn-cancel" type="button" (click)="onCancel()">
              Quay lại
            </button>
            <button class="btn-trace" type="button" (click)="viewRelatedEvents()">
              <mat-icon>timeline</mat-icon>
              Truy vết sự kiện liên quan
            </button>
            <button class="btn-edit" type="button" (click)="editObject()">
              <mat-icon>edit</mat-icon>
              Chỉnh sửa
            </button>
          </ng-container>

          <!-- Edit/Add Mode Actions -->
          <ng-container *ngIf="!isViewMode">
            <button class="btn-cancel" type="button" (click)="onCancel()" [disabled]="isSaving">
              Hủy
            </button>
            <button class="btn-save" type="submit" [disabled]="isSaving">
              <span *ngIf="!isSaving">{{ isEditMode ? 'Lưu chỉnh sửa' : 'Lưu' }}</span>
              <span *ngIf="isSaving">Đang lưu...</span>
            </button>
          </ng-container>
        </div>
      </form>
    </div>
  </div>
</div>
